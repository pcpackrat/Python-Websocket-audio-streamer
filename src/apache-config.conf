# Apache Virtual Host Configuration for AllStarLink Audio Monitor
# 
# This configuration serves the web interface and proxies WebSocket connections
# to the Python backend running on port 8080.
#
# INSTALLATION INSTRUCTIONS:
# 
# 1. Enable required Apache modules:
#    sudo a2enmod proxy
#    sudo a2enmod proxy_http
#    sudo a2enmod proxy_wstunnel
#    sudo a2enmod rewrite
#
# 2. Copy this file to Apache sites-available:
#    sudo cp apache-config.conf /etc/apache2/sites-available/asl-monitor.conf
#
# 3. Update the DocumentRoot path below to match your installation
#
# 4. Enable the site:
#    sudo a2ensite asl-monitor.conf
#
# 5. Test configuration:
#    sudo apache2ctl configtest
#
# 6. Reload Apache:
#    sudo systemctl reload apache2
#
# 7. Start the Python WebSocket server:
#    python3 usrp_ws.py
#
# 8. Access the monitor at: http://your-server-ip/

<VirtualHost *:80>
    ServerName localhost
    ServerAdmin webmaster@localhost

    # Update this path to your actual installation directory
    DocumentRoot /var/www/html/asl-monitor

    <Directory /var/www/html/asl-monitor>
        Options -Indexes +FollowSymLinks
        AllowOverride None
        Require all granted
    </Directory>

    # WebSocket proxy to Python backend
    ProxyPreserveHost On
    
    # WebSocket endpoint
    ## Configuration for the allmon3 application
    ##

    Alias /allmon3 /usr/share/allmon3

    <Directory /usr/share/allmon3>
            AllowOverride all

        # Implement rewrite within the directory so that is survives
        # into the <VirtualHost> tags
        RewriteEngine On
        RewriteCond %{HTTP:Upgrade} =websocket [NC]
        RewriteRule ^ws/([0-9]+) ws://localhost:$1 [P,L,QSA]
    </Directory>

    # Proxy can't usefully occur inside a <Directory> on Debian
    ProxyAddHeaders On
    ProxyPreserveHost On
    ProxyPass /allmon3/master/ "http://localhost:16080/"

    # USRP Audio Streamer WebSocket Proxy
    ProxyPass /allmon3/audio-ws ws://localhost:8080/
    ProxyPassReverse /allmon3/audio-ws ws://localhost:8080/$1 [P,L]

    # Logging
    ErrorLog ${APACHE_LOG_DIR}/asl-monitor-error.log
    CustomLog ${APACHE_LOG_DIR}/asl-monitor-access.log combined
</VirtualHost>

# Alternative configuration for a subdirectory (e.g., http://server/asl-monitor/)
# Uncomment and modify if you want to serve from a subdirectory instead:
#
# Alias /asl-monitor /var/www/html/asl-monitor
# 
# <Directory /var/www/html/asl-monitor>
#     Options -Indexes +FollowSymLinks
#     AllowOverride None
#     Require all granted
# </Directory>
#
# ProxyPass /asl-monitor/ws ws://localhost:8080/
# ProxyPassReverse /asl-monitor/ws ws://localhost:8080/
